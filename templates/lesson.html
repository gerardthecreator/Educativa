{% extends 'layout.html' %}

{% block content %}
<div class="lesson-container">
    <nav class="breadcrumbs">
        <a href="{{ url_for('dashboard') }}">Dashboard</a> &raquo;
        <a href="{{ url_for('dashboard') }}#{{ subject_name }}">{{ subject_name|capitalize }}</a> &raquo;
        <span>{{ lesson.title }}</span>
    </nav>

    <article class="lesson-content-box">
        <h1 class="lesson-title">{{ lesson.title }}</h1>
        
        {% if lesson.video_url %}
            <div class="video-container">
                <iframe 
                    src="{{ lesson.video_url }}" 
                    title="Video de la lección: {{ lesson.title }}" 
                    frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
        {% endif %}
        
        <div class="lesson-text">
            {% for block in lesson.content_blocks %}
                {% if block.type == 'html' %}
                    {{ block.content|safe }}
                {% elif block.type == 'canvas' %}
                    <div class="canvas-wrapper">
                        <canvas id="{{ block.canvas_id }}" width="500" height="300"></canvas>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <div class="lesson-actions">
            {% if lesson.quiz %}
            <a href="{{ url_for('take_quiz', subject_slug=subject_name, lesson_slug=lesson.slug) }}" class="btn btn-primary">Realizar Autoevaluación &rarr;</a>
            {% endif %}
        </div>
    </article>

    <div class="lesson-navigation">
        {% if prev_lesson %}
            <a href="{{ url_for('view_lesson', subject_slug=subject_name, lesson_slug=prev_lesson.slug) }}" class="nav-button prev-button">
                &larr; Lección Anterior
            </a>
        {% endif %}
        {% if next_lesson %}
            <a href="{{ url_for('view_lesson', subject_slug=subject_name, lesson_slug=next_lesson.slug) }}" class="nav-button next-button">
                Siguiente Lección &rarr;
            </a>
        {% endif %}
    </div>
</div>

<!-- Script JavaScript específico para esta lección (para dibujar en los Canvas) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvasPainters = {
        drawVectorDiagram: (canvasId) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const cw = canvas.width;
            const ch = canvas.height;
            const origin = { x: 50, y: ch - 50 };
            ctx.beginPath();
            ctx.moveTo(origin.x, 0); ctx.lineTo(origin.x, ch);
            ctx.moveTo(0, origin.y); ctx.lineTo(cw, origin.y);
            ctx.strokeStyle = '#ccc';
            ctx.stroke();
            const vx = 200, vy = -150;
            ctx.beginPath();
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(origin.x + vx, origin.y + vy);
            ctx.strokeStyle = '#2196F3'; /* Azul secundario */
            ctx.lineWidth = 3;
            ctx.stroke();
        },
        drawVectorSum: (canvasId, data) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const scale = 40;
            const origin = { x: 50, y: canvas.height - 50 };
            const a = {x: data.vectorA[0] * scale, y: -data.vectorA[1] * scale};
            const b = {x: data.vectorB[0] * scale, y: -data.vectorB[1] * scale};
            const c = {x: a.x + b.x, y: a.y + b.y};
            ctx.beginPath();
            ctx.moveTo(origin.x, 0); ctx.lineTo(origin.x, canvas.height);
            ctx.moveTo(0, origin.y); ctx.lineTo(canvas.width, origin.y);
            ctx.strokeStyle = '#ccc';
            ctx.stroke();
            const drawArrow = (from, to, color) => {
                ctx.beginPath();
                ctx.moveTo(from.x, from.y);
                ctx.lineTo(to.x, to.y);
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.stroke();
            };
            drawArrow(origin, {x: origin.x + a.x, y: origin.y + a.y}, '#FFC107'); // Vector a (amarillo)
            drawArrow({x: origin.x + a.x, y: origin.y + a.y}, {x: origin.x + c.x, y: origin.y + c.y}, '#2196F3'); // Vector b (azul)
            drawArrow(origin, {x: origin.x + c.x, y: origin.y + c.y}, '#4CAF50'); // Vector c (verde)
        }
    };

    const lessonData = {{ lesson|tojson }};
    if (lessonData && lessonData.content_blocks) {
        lessonData.content_blocks.forEach(block => {
            if (block.type === 'canvas' && block.script in canvasPainters) {
                canvasPainters[block.script](block.canvas_id, block.data);
            }
        });
    }
});
</script>
{% endblock %}
